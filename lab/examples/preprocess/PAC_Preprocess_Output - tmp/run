#! /usr/bin/env python

import sys
import os
import multiprocessing
import subprocess

# make sure we're in the run directory
os.chdir(os.path.dirname(os.path.abspath(__file__)))


dirs = [
'runs-00001-00100/00001',
'runs-00001-00100/00002',
'runs-00001-00100/00003',
'runs-00001-00100/00004',
'runs-00001-00100/00005',
'runs-00001-00100/00006',
'runs-00001-00100/00007',
'runs-00001-00100/00008',
'runs-00001-00100/00009',
'runs-00001-00100/00010',
'runs-00001-00100/00011',
'runs-00001-00100/00012',
'runs-00001-00100/00013',
'runs-00001-00100/00014',
'runs-00001-00100/00015',
'runs-00001-00100/00016',
'runs-00001-00100/00017',
'runs-00001-00100/00018',
'runs-00001-00100/00019',
'runs-00001-00100/00020',
'runs-00001-00100/00021',
'runs-00001-00100/00022',
'runs-00001-00100/00023',
'runs-00001-00100/00024',
'runs-00001-00100/00025',
'runs-00001-00100/00026',
'runs-00001-00100/00027',
'runs-00001-00100/00028',
'runs-00001-00100/00029',
'runs-00001-00100/00030',
'runs-00001-00100/00031',
'runs-00001-00100/00032',
'runs-00001-00100/00033',
'runs-00001-00100/00034',
'runs-00001-00100/00035',
'runs-00001-00100/00036',
'runs-00001-00100/00037',
'runs-00001-00100/00038',
'runs-00001-00100/00039',
'runs-00001-00100/00040',
'runs-00001-00100/00041',
'runs-00001-00100/00042',
'runs-00001-00100/00043',
'runs-00001-00100/00044',
'runs-00001-00100/00045',
'runs-00001-00100/00046',
'runs-00001-00100/00047',
'runs-00001-00100/00048',
'runs-00001-00100/00049',
'runs-00001-00100/00050',
'runs-00001-00100/00051',
'runs-00001-00100/00052',
'runs-00001-00100/00053',
'runs-00001-00100/00054',
'runs-00001-00100/00055',
'runs-00001-00100/00056',
'runs-00001-00100/00057',
'runs-00001-00100/00058',
'runs-00001-00100/00059',
'runs-00001-00100/00060',
'runs-00001-00100/00061',
'runs-00001-00100/00062',
'runs-00001-00100/00063',
'runs-00001-00100/00064',
'runs-00001-00100/00065',
'runs-00001-00100/00066',
'runs-00001-00100/00067',
'runs-00001-00100/00068',
'runs-00001-00100/00069',
'runs-00001-00100/00070',
'runs-00001-00100/00071',
'runs-00001-00100/00072',
'runs-00001-00100/00073',
'runs-00001-00100/00074',
'runs-00001-00100/00075',
'runs-00001-00100/00076',
'runs-00001-00100/00077',
'runs-00001-00100/00078',
'runs-00001-00100/00079',
'runs-00001-00100/00080',
'runs-00001-00100/00081',
'runs-00001-00100/00082',
'runs-00001-00100/00083',
'runs-00001-00100/00084',
'runs-00001-00100/00085',
'runs-00001-00100/00086',
'runs-00001-00100/00087',
'runs-00001-00100/00088',
'runs-00001-00100/00089',
'runs-00001-00100/00090',
'runs-00001-00100/00091',
'runs-00001-00100/00092',
'runs-00001-00100/00093',
'runs-00001-00100/00094',
'runs-00001-00100/00095',
'runs-00001-00100/00096',
'runs-00001-00100/00097',
'runs-00001-00100/00098',
'runs-00001-00100/00099',
'runs-00001-00100/00100',
'runs-00101-00200/00101',
'runs-00101-00200/00102',
'runs-00101-00200/00103',
'runs-00101-00200/00104',
'runs-00101-00200/00105',
'runs-00101-00200/00106',
'runs-00101-00200/00107',
'runs-00101-00200/00108',
'runs-00101-00200/00109',
'runs-00101-00200/00110',
'runs-00101-00200/00111',
'runs-00101-00200/00112',
'runs-00101-00200/00113',
'runs-00101-00200/00114',
'runs-00101-00200/00115',
'runs-00101-00200/00116',
'runs-00101-00200/00117',
'runs-00101-00200/00118',
'runs-00101-00200/00119',
'runs-00101-00200/00120',
'runs-00101-00200/00121',
'runs-00101-00200/00122',
'runs-00101-00200/00123',
'runs-00101-00200/00124',
'runs-00101-00200/00125',
'runs-00101-00200/00126',
'runs-00101-00200/00127',
'runs-00101-00200/00128',
'runs-00101-00200/00129',
'runs-00101-00200/00130',
'runs-00101-00200/00131',
'runs-00101-00200/00132',
'runs-00101-00200/00133',
'runs-00101-00200/00134',
'runs-00101-00200/00135',
'runs-00101-00200/00136',
'runs-00101-00200/00137',
'runs-00101-00200/00138',
'runs-00101-00200/00139',
'runs-00101-00200/00140',
'runs-00101-00200/00141',
'runs-00101-00200/00142',
'runs-00101-00200/00143',
'runs-00101-00200/00144',
'runs-00101-00200/00145',
'runs-00101-00200/00146',
'runs-00101-00200/00147',
'runs-00101-00200/00148',
'runs-00101-00200/00149',
'runs-00101-00200/00150',
'runs-00101-00200/00151',
'runs-00101-00200/00152',
'runs-00101-00200/00153',
'runs-00101-00200/00154',
'runs-00101-00200/00155',
'runs-00101-00200/00156',
'runs-00101-00200/00157',
'runs-00101-00200/00158',
'runs-00101-00200/00159',
'runs-00101-00200/00160',
'runs-00101-00200/00161',
'runs-00101-00200/00162',
'runs-00101-00200/00163',
'runs-00101-00200/00164',
'runs-00101-00200/00165'
]


def process_dir(dir):
    number = dir.split('/')[-1]
    print 'Starting run %s/%s' % (number, str(len(dirs)).zfill(5))
    run = subprocess.Popen(['./run'], cwd=dir, stdout=sys.stdout, stderr=sys.stderr)
    try:
        run.wait()
    except KeyboardInterrupt:
        print 'Call to run %s interrupted' % number
        run.terminate()
    except OSError, err:
        print err


def main():
    pool = multiprocessing.Pool(processes=4)
    try:
        pool.map(process_dir, dirs, chunksize=1)
    except KeyboardInterrupt:
        print 'Main script interrupted'
        pool.terminate()
    finally:
        pool.close()
        print 'Joining pool processes'
        pool.join()


if __name__ == '__main__':
    main()
